# ./nginx/nginx.conf  (ใช้กับ image: nginx:alpine)

# ไม่กำหนด user (ให้ใช้ค่าดีฟอลต์ของ image คือ 'nginx')
worker_processes auto;
pid /run/nginx.pid;

events {
  worker_connections 4096;
}

# ❌ ตัด TCP/RTMP stream ออก (ถ้าจะใช้ค่อยใส่ libnginx-mod-stream/rtmp ภายหลัง)
# include /etc/nginx/streams-enabled/*.conf;

http {
  include       /etc/nginx/mime.types;
  default_type  application/octet-stream;

  sendfile on;
  tcp_nopush on;
  tcp_nodelay on;
  keepalive_timeout 65;

  # ---- Gzip ----
  gzip on;
  gzip_comp_level 5;
  gzip_min_length 256;
  gzip_types
    text/plain
    text/css
    application/json
    application/javascript
    application/xml
    image/svg+xml;

  # ---- (ออปชัน) Cloudflare Real IP ----
  # แนะนำใส่เฉพาะ IP ranges ของ Cloudflare จริง ๆ (อย่าใช้ 0.0.0.0/0)
  # real_ip_header CF-Connecting-IP;
  # include /etc/nginx/cloudflare/ips.conf;

  # ---- WebSocket/Proxy defaults ----
  map $http_upgrade $connection_upgrade {
    default upgrade;
    ''      close;
  }

  proxy_read_timeout 300s;
  proxy_send_timeout 300s;
  proxy_http_version 1.1;
  proxy_set_header Host $host;
  proxy_set_header X-Real-IP $remote_addr;
  proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  proxy_set_header X-Forwarded-Proto $scheme;
  proxy_set_header Upgrade $http_upgrade;
  proxy_set_header Connection $connection_upgrade;

  # โหลด vhost ทั้งหมดจาก conf.d (คุณแมพ ./nginx/sites-available มาที่นี่)
  include /etc/nginx/conf.d/*.conf;

  # ไม่ต้อง include sites-enabled ในคอนเทนเนอร์นี้
  # include /etc/nginx/sites-enabled/*.conf;
}
